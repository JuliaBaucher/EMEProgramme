<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EME ‚Äî Assistant (Extended Monaco Entreprises)</title>
  <meta name="description" content="Assistant officiel du programme Extended Monaco Entreprises (EME) ‚Äî Acc√©l√©rateur de la transformation num√©rique des entreprises mon√©gasques." />
  <meta name="color-scheme" content="light dark" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">

  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

  <style>
    :root{
      --monaco-red:#CE1126; --monaco-red-rgb:206,17,38;
      --monaco-white:#fff; --monaco-white-rgb:255,255,255;

      --primary-blue:#003366; --primary-blue-rgb:0,51,102;
      --secondary-blue:#0066CC; --secondary-blue-rgb:0,102,204;

      --gray-900:#212529; --gray-800:#343A40; --gray-700:#495057;
      --gray-600:#6C757D; --gray-500:#ADB5BD; --gray-400:#CED4DA;
      --gray-300:#DEE2E6; --gray-200:#E9ECEF; --gray-100:#F8F9FA;

      --font-primary:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
      --font-secondary:'Roboto','Source Sans Pro',sans-serif;
      --font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;

      --text-xs:0.75rem; --text-sm:0.875rem; --text-base:1rem; --text-lg:1.125rem; --text-xl:1.25rem;

      --leading-tight:1.25; --leading-normal:1.5; --leading-relaxed:1.75;

      --space-1:0.25rem; --space-2:0.5rem; --space-3:0.75rem; --space-4:1rem;
      --space-6:1.5rem; --space-8:2rem; --space-12:3rem;

      --radius-sm:0.125rem; --radius-md:0.375rem; --radius-lg:0.5rem; --radius-full:9999px;

      --shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);

      --container-max-width:1280px;
      --bubble-user-bg:rgba(var(--secondary-blue-rgb),0.10);
      --bubble-assistant-bg:rgba(0,0,0,0.03);
      --bubble-system-bg:rgba(var(--monaco-red-rgb),0.08);

      --header-height:84px;
      --input-max-chars:4000;
    }

    :root[data-theme="dark"]{
      --gray-100:#0b1220; --gray-200:#111a2e;
      --gray-300:rgba(255,255,255,0.12); --gray-400:rgba(255,255,255,0.18);
      --gray-500:rgba(255,255,255,0.28); --gray-600:rgba(255,255,255,0.55);
      --gray-700:rgba(255,255,255,0.75); --gray-800:rgba(255,255,255,0.88);
      --gray-900:rgba(255,255,255,0.96);

      --bubble-assistant-bg:rgba(255,255,255,0.06);
      --bubble-user-bg:rgba(var(--secondary-blue-rgb),0.18);
      --bubble-system-bg:rgba(var(--monaco-red-rgb),0.18);
    }

    @media (prefers-color-scheme:dark){
      :root:not([data-theme]){
        --gray-100:#0b1220; --gray-200:#111a2e;
        --gray-300:rgba(255,255,255,0.12); --gray-400:rgba(255,255,255,0.18);
        --gray-500:rgba(255,255,255,0.28); --gray-600:rgba(255,255,255,0.55);
        --gray-700:rgba(255,255,255,0.75); --gray-800:rgba(255,255,255,0.88);
        --gray-900:rgba(255,255,255,0.96);

        --bubble-assistant-bg:rgba(255,255,255,0.06);
        --bubble-user-bg:rgba(var(--secondary-blue-rgb),0.18);
        --bubble-system-bg:rgba(var(--monaco-red-rgb),0.18);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font-primary);
      color:var(--gray-800);
      background:linear-gradient(180deg,var(--gray-100),var(--gray-200));
      line-height:var(--leading-normal);
    }

    a{color:var(--secondary-blue);text-decoration:none}
    a:hover{text-decoration:underline}

    .skip-link{
      position:absolute; top:-40px; left:6px;
      background:var(--primary-blue); color:var(--monaco-white);
      padding:var(--space-2) var(--space-4);
      border-radius:var(--radius-md);
      z-index:1000;
    }
    .skip-link:focus{top:6px;outline:2px solid var(--secondary-blue);outline-offset:2px}

    .container{max-width:var(--container-max-width);margin:0 auto;padding:var(--space-6) var(--space-4)}

    header.gov-header{
      background:var(--primary-blue);
      color:var(--monaco-white);
      box-shadow:var(--shadow-md);
      position:sticky; top:0; z-index:10;
    }
    .gov-header__inner{
      max-width:var(--container-max-width);
      margin:0 auto;
      padding:var(--space-4);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-4);
      min-height:var(--header-height);
    }
    .brand{display:flex;align-items:center;gap:var(--space-3);min-width:0}
    .flag{width:34px;height:22px;border-radius:3px;overflow:hidden;box-shadow:0 0 0 1px rgba(255,255,255,0.25);flex:0 0 auto}
    .flag__top{height:50%;background:var(--monaco-white)}
    .flag__bottom{height:50%;background:var(--monaco-red)}
    .brand__text{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand__title{
      font-family:var(--font-secondary);
      font-weight:600;
      font-size:var(--text-lg);
      margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand__subtitle{
      margin:0;
      font-size:var(--text-sm);
      color:rgba(255,255,255,0.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .header-actions{display:flex;align-items:center;gap:var(--space-2);flex:0 0 auto}
    .btn{
      border:2px solid transparent;
      border-radius:var(--radius-md);
      padding:var(--space-2) var(--space-4);
      font:inherit;
      font-weight:500;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, background-color .15s ease, border-color .15s ease;
      display:inline-flex; align-items:center; gap:var(--space-2);
      background:transparent; color:var(--monaco-white);
    }
    .btn:focus{outline:2px solid var(--secondary-blue);outline-offset:2px}
    .btn--ghost{border-color:rgba(255,255,255,0.25)}
    .btn--ghost:hover{border-color:rgba(255,255,255,0.45);transform:translateY(-1px)}
    .btn--primary{background:var(--secondary-blue);border-color:var(--secondary-blue)}
    .btn--primary:hover{background:var(--primary-blue);border-color:var(--primary-blue);transform:translateY(-1px);box-shadow:var(--shadow-sm)}

    .main{min-height:calc(100vh - var(--header-height,84px))}
    .layout{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:var(--space-6);
      align-items:start;
    }
    .content{min-width:0}
    .sidebar{
      position:sticky;
      top:var(--space-6);
      max-height:calc(100vh - var(--header-height,84px) - var(--space-12));
      overflow:auto;
      padding-right:var(--space-2);
    }
    @media (max-width:1024px){
      .layout{grid-template-columns:1fr}
      .sidebar{position:static;max-height:none;overflow:visible;padding-right:0}
    }

    .card{
      background:var(--monaco-white);
      border:1px solid var(--gray-300);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      overflow:hidden;
    }
    :root[data-theme="dark"] .card{background:rgba(255,255,255,0.04)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .card{background:rgba(255,255,255,0.04)} }

    .card__header{
      padding:var(--space-6);
      border-bottom:1px solid var(--gray-300);
      display:flex;align-items:center;justify-content:space-between;gap:var(--space-4);
    }
    .card__title{
      font-family:var(--font-secondary);
      font-size:var(--text-xl);
      font-weight:600;
      color:var(--primary-blue);
      margin:0;
      line-height:var(--leading-tight);
    }
    :root[data-theme="dark"] .card__title{color:rgba(255,255,255,0.95)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .card__title{color:rgba(255,255,255,0.95)} }

    .monaco-accent{border-left:4px solid var(--monaco-red);padding-left:var(--space-4)}

    /* =========================
       CHAT (UX FIX)
       The ‚Äúempty space under the disclaimer‚Äù is the empty messages area.
       We fill it with Quick Questions + tips INSIDE the chat panel (not as a separate card).
       ========================= */
    .chat{
      display:flex;
      flex-direction:column;
      height:min(84vh, 980px);
    }

    .chat__disclaimer{
      padding:var(--space-4) var(--space-6);
      border-bottom:1px solid var(--gray-300);
      background:rgba(0,0,0,0.015);
      font-size:var(--text-sm);
      color:var(--gray-700);
    }
    :root[data-theme="dark"] .chat__disclaimer{background:rgba(255,255,255,0.03)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .chat__disclaimer{background:rgba(255,255,255,0.03)} }

    .chat__messages{
      padding:var(--space-6);
      overflow:auto;
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:var(--space-4);
    }

    /* Empty-state panel = only actionable UI (no ‚ÄúBienvenue‚Äù text) */
    .empty-panel{
      border:1px dashed var(--gray-300);
      border-radius:var(--radius-lg);
      padding:var(--space-6);
      background:rgba(0,0,0,0.01);
    }
    :root[data-theme="dark"] .empty-panel{background:rgba(255,255,255,0.03)}

    .empty-panel__title{
      margin:0 0 var(--space-3);
      font-family:var(--font-secondary);
      font-weight:600;
      font-size:var(--text-lg);
      color:var(--gray-800);
    }
    :root[data-theme="dark"] .empty-panel__title{color:rgba(255,255,255,0.95)}

    .empty-panel__hint{
      margin:0 0 var(--space-4);
      color:var(--gray-700);
      font-size:var(--text-sm);
      line-height:var(--leading-relaxed);
    }

    .quick-questions{
      display:flex;
      flex-wrap:wrap;
      gap:var(--space-2);
    }

    .msg{display:flex;gap:var(--space-3);margin-bottom:var(--space-4);align-items:flex-start}
    .msg__avatar{width:36px;height:36px;border-radius:var(--radius-full);background:rgba(0,0,0,0.06);display:grid;place-items:center;flex:0 0 auto;border:1px solid var(--gray-300);user-select:none}
    :root[data-theme="dark"] .msg__avatar{background:rgba(255,255,255,0.06)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .msg__avatar{background:rgba(255,255,255,0.06)} }
    .msg__avatar span{font-size:14px;font-weight:600;color:var(--gray-700)}

    .msg__bubble{
      max-width:78ch;
      padding:var(--space-4);
      border-radius:var(--radius-lg);
      border:1px solid var(--gray-300);
      box-shadow:var(--shadow-sm);
      background:var(--bubble-assistant-bg);
      color:var(--gray-800);
      min-width:0;
      width:100%;
    }
    .msg--user .msg__bubble{background:var(--bubble-user-bg);border-color:rgba(var(--secondary-blue-rgb),0.35)}
    .msg--system .msg__bubble{background:var(--bubble-system-bg);border-color:rgba(var(--monaco-red-rgb),0.35)}

    .msg__meta{display:flex;gap:var(--space-3);align-items:baseline;margin-bottom:var(--space-2);color:var(--gray-600);font-size:var(--text-xs)}
    .msg__role{font-weight:600;color:var(--gray-700)}
    .msg__content{white-space:pre-wrap;overflow-wrap:anywhere;font-size:var(--text-base);line-height:var(--leading-relaxed)}

    .msg__actions{margin-top:var(--space-3);display:flex;gap:var(--space-2);flex-wrap:wrap}

    .chip{
      font-size:var(--text-xs);
      padding:0.35rem 0.55rem;
      border-radius:var(--radius-full);
      border:1px solid var(--gray-300);
      background:rgba(0,0,0,0.03);
      color:var(--gray-700);
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, background-color .15s ease;
    }
    .chip:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .chip:focus{outline:2px solid var(--secondary-blue);outline-offset:2px}

    .composer{
      border-top:1px solid var(--gray-300);
      padding:var(--space-4);
      background:rgba(0,0,0,0.015);
    }
    :root[data-theme="dark"] .composer{background:rgba(255,255,255,0.03)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .composer{background:rgba(255,255,255,0.03)} }

    .composer__row{display:flex;gap:var(--space-3);align-items:flex-end}
    .textarea-wrap{flex:1 1 auto;display:flex;flex-direction:column;gap:var(--space-2);min-width:0}

    textarea{
      width:100%;
      resize:none;
      min-height:72px;
      max-height:220px;
      padding:var(--space-3);
      border-radius:var(--radius-md);
      border:2px solid var(--gray-400);
      background:var(--monaco-white);
      color:var(--gray-900);
      font-family:var(--font-primary);
      font-size:var(--text-base);
      line-height:var(--leading-normal);
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    :root[data-theme="dark"] textarea{background:rgba(255,255,255,0.06);color:var(--gray-900)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) textarea{background:rgba(255,255,255,0.06);color:var(--gray-900)} }
    textarea:focus{outline:none;border-color:var(--secondary-blue);box-shadow:0 0 0 3px rgba(var(--secondary-blue-rgb),0.12)}

    .counter{display:flex;justify-content:space-between;align-items:center;font-size:var(--text-xs);color:var(--gray-600)}
    .counter__hint kbd{
      font-family:var(--font-mono);
      font-size:0.95em;
      border:1px solid var(--gray-400);
      border-bottom-width:2px;
      border-radius:var(--radius-sm);
      padding:0.05em 0.35em;
      background:rgba(0,0,0,0.03);
    }
    .counter__count{
      font-variant-numeric:tabular-nums;
      padding:0.15rem 0.5rem;
      border-radius:var(--radius-full);
      border:1px solid var(--gray-300);
      background:rgba(0,0,0,0.03);
    }
    .counter__count.warn{background:rgba(255,193,7,0.2);border-color:rgba(255,193,7,0.5);color:var(--gray-800)}
    .counter__count.danger{background:rgba(220,53,69,0.18);border-color:rgba(220,53,69,0.45);color:var(--gray-900)}

    .send-btn{
      flex:0 0 auto;
      min-width:132px;
      height:56px;
      border-radius:var(--radius-md);
      border:2px solid var(--secondary-blue);
      background:var(--secondary-blue);
      color:var(--monaco-white);
      font-weight:500;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, background-color .15s ease, border-color .15s ease;
    }
    .send-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm);background:var(--primary-blue);border-color:var(--primary-blue)}
    .send-btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}

    .icon-btn{
      height:56px;width:56px;
      border-radius:var(--radius-md);
      border:2px solid var(--gray-300);
      background:transparent;
      cursor:pointer;
      color:var(--gray-800);
      display:grid;place-items:center;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .icon-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm);border-color:var(--gray-400)}
    .send-btn:focus, .icon-btn:focus, .btn:focus{outline:2px solid var(--secondary-blue);outline-offset:2px}

    /* Sidebar */
    .side{padding:var(--space-6)}
    .side h2{font-family:var(--font-secondary);font-size:var(--text-lg);margin:0 0 var(--space-3);color:var(--primary-blue)}
    :root[data-theme="dark"] .side h2{color:rgba(255,255,255,0.95)}
    @media (prefers-color-scheme:dark){ :root:not([data-theme]) .side h2{color:rgba(255,255,255,0.95)} }
    .side p{margin:0 0 var(--space-4);color:var(--gray-700);font-size:var(--text-sm);line-height:var(--leading-relaxed)}
    .quick-links{display:grid;gap:var(--space-2);margin-bottom:var(--space-6)}
    .quick-links a{
      display:inline-flex;align-items:center;justify-content:space-between;gap:var(--space-2);
      padding:var(--space-3) var(--space-4);
      border-radius:var(--radius-md);
      border:1px solid var(--gray-300);
      background:rgba(0,0,0,0.02);
      color:var(--gray-800);
      font-weight:500;
      transition:transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .quick-links a:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm);border-color:var(--gray-400)}

    footer{padding:var(--space-8) 0;color:var(--gray-600);font-size:var(--text-sm)}

    @media (max-width:768px){
      .gov-header__inner{flex-wrap:wrap}
      .header-actions{width:100%;justify-content:flex-start}
      .chat{height:min(86vh, 1100px)}
      .send-btn{min-width:110px}
      .msg__bubble{max-width:100%}
    }

    /* Make messages full-width (no left avatar column) */
    .msg{gap:0}
    .msg__avatar{display:none}
    .msg__bubble{max-width:100%;width:100%}
  </style>
</head>

<body>
  <a class="skip-link" href="#chat">Aller au contenu</a>

  <header class="gov-header" role="banner">
    <div class="gov-header__inner">
      <div class="brand" aria-label="Extended Monaco Entreprises">
        <div class="flag" aria-hidden="true">
          <div class="flag__top"></div>
          <div class="flag__bottom"></div>
        </div>
        <div class="brand__text">
          <p class="brand__title">Extended Monaco Entreprises (EME)</p>
          <p class="brand__subtitle">Assistant officiel ‚Äî Transformation num√©rique des entreprises mon√©gasques</p>
        </div>
      </div>

      <div class="header-actions" role="group" aria-label="Actions">
        <button class="btn btn--ghost" id="themeToggle" type="button" aria-label="Basculer le mode clair/sombre">
          üåì <span style="font-size:0.95em;">Th√®me</span>
        </button>
        <button class="btn btn--ghost" id="clearChatTop" type="button" aria-label="Effacer l'historique de conversation">
          üßπ <span style="font-size:0.95em;">Effacer</span>
        </button>
        <a class="btn btn--primary" href="https://eme.gouv.mc/" target="_blank" rel="noopener" aria-label="Ouvrir le site officiel EME">
          üåê <span style="font-size:0.95em;">Site EME</span>
        </a>
      </div>
    </div>
  </header>

  <main class="main" role="main">
    <div class="container">
      <div class="layout">

        <section class="content" aria-label="Zone principale">
          <section class="card chat chat-card" aria-label="Chat EME">
            <div class="card__header">
              <div class="monaco-accent">
                <h1 class="card__title" style="margin:0;">Concierge EME</h1>
                <div style="margin-top:6px;font-size:var(--text-sm);color:var(--gray-700);">
                  Posez vos questions sur : autodiagnostic, annuaire, Fonds Bleu, FlashUP, FlashLearn IA (2026).
                </div>
              </div>
              <button class="btn btn--ghost" id="copyTranscript" type="button" aria-label="Copier la conversation">
                üìã <span style="font-size:0.95em;">Copier</span>
              </button>
            </div>

            <div class="chat__disclaimer" id="disclaimer" role="note">
              <strong>Transparence IA :</strong> cet assistant fournit des informations g√©n√©rales sur le programme EME.
              Il ne remplace pas un conseil juridique/financier et ne garantit pas l‚Äô√©ligibilit√© au Fonds Bleu.
              √âvitez de partager des donn√©es sensibles. Besoin d‚Äôun humain ? Consultez la page
              <a href="https://eme.gouv.mc/contact" target="_blank" rel="noopener">Contact</a> ou la
              <a href="https://eme.gouv.mc/" target="_blank" rel="noopener">F.A.Q.</a>.
            </div>

            <div id="chat"
                 class="chat__messages"
                 tabindex="0"
                 aria-label="Historique de conversation"
                 aria-live="polite"
                 aria-relevant="additions text">

              <!-- ‚úÖ UX FIX: This panel fills the ‚Äúempty space‚Äù when there are no messages.
                   It contains ONLY actionable UI (no welcome text). -->
              <div id="emptyPanel" class="empty-panel" hidden>
                <h3 class="empty-panel__title">Questions rapides</h3>
                <p class="empty-panel__hint">Cliquez sur une question pour pr√©-remplir votre message.</p>
                <div class="quick-questions">
                  <button class="chip" data-q="C‚Äôest quoi le programme EME et √† qui s‚Äôadresse-t-il ?">EME : objectifs</button>
                  <button class="chip" data-q="Comment fonctionne l‚Äôautodiagnostic de maturit√© num√©rique (dur√©e, score, dimensions) ?">Autodiagnostic</button>
                  <button class="chip" data-q="Comment utiliser l‚Äôannuaire des professionnels du num√©rique ?">Annuaire</button>
                  <button class="chip" data-q="Que propose le programme de sensibilisation Digital FlashUP ?">FlashUP</button>
                  <button class="chip" data-q="Que finance le Fonds Bleu et quels sont les d√©lais de traitement ?">Fonds Bleu</button>
                  <button class="chip" data-q="Quelles sont les nouveaut√©s 2026 (Questionnaire Opportunit√© IA, FlashLearn IA) ?">Nouveaut√©s 2026</button>
                </div>
              </div>
            </div>

            <div class="composer" aria-label="Zone de saisie">
              <div class="composer__row">
                <div class="textarea-wrap">
                  <textarea id="input"
                            placeholder="√âcrivez votre question‚Ä¶ (Entr√©e pour envoyer, Shift+Entr√©e pour une nouvelle ligne)"
                            aria-label="Message"
                            maxlength="4000"></textarea>

                  <div class="counter" aria-label="Indicateur de longueur">
                    <div class="counter__hint">
                      <span>Raccourcis :</span>
                      <kbd>Entr√©e</kbd> envoyer ¬∑ <kbd>Shift</kbd>+<kbd>Entr√©e</kbd> nouvelle ligne
                    </div>
                    <div id="count" class="counter__count">0 / 4000</div>
                  </div>
                </div>

                <button id="send" class="send-btn" type="button" aria-label="Envoyer le message" disabled>Envoyer</button>
                <button id="clearChat" class="icon-btn" type="button" aria-label="Effacer la conversation">üßπ</button>
              </div>
            </div>
          </section>
        </section>

        <aside class="card side sidebar" aria-label="Aide et ressources">
          <h2>Raccourcis utiles</h2>
          <p>Acc√©dez rapidement aux ressources EME (site officiel).</p>

          <div class="quick-links" role="list">
            <a role="listitem" href="https://eme.gouv.mc/evaluer-sa-maturite-numerique/" target="_blank" rel="noopener">
              Autodiagnostic de maturit√© num√©rique <span aria-hidden="true">‚Üí</span>
            </a>
            <a role="listitem" href="https://eme.gouv.mc/rechercher-un-professionnel-du-numerique/" target="_blank" rel="noopener">
              Annuaire des professionnels du num√©rique <span aria-hidden="true">‚Üí</span>
            </a>
            <a role="listitem" href="https://eme.gouv.mc/programme-de-sensibilisation/" target="_blank" rel="noopener">
              Programme de sensibilisation (FlashUP) <span aria-hidden="true">‚Üí</span>
            </a>
            <a role="listitem" href="https://eme.gouv.mc/flashup-tool-box/" target="_blank" rel="noopener">
              FlashUP Tool Box <span aria-hidden="true">‚Üí</span>
            </a>
            <a role="listitem" href="https://eme.gouv.mc/financer-son-projet-3/" target="_blank" rel="noopener">
              Financer son projet (Fonds Bleu) <span aria-hidden="true">‚Üí</span>
            </a>
          </div>
        </aside>

      </div>

      <footer class="container" role="contentinfo">
        ¬© Extended Monaco Entreprises ‚Äî Interface de d√©monstration (frontend). Pour les informations officielles, consulter le site EME.
      </footer>
    </div>
  </main>

  <script>
    const API_URL = ""; // leave empty for demo mode (no network)

    const STORAGE_KEY = "eme_chat_v1";
    const THEME_KEY = "eme_theme_v1";
    const MAX_CHARS = 4000;
    const TIMEOUT_MS = 30000;

    const chatEl = document.getElementById("chat");
    const emptyPanelEl = document.getElementById("emptyPanel");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const clearBtn = document.getElementById("clearChat");
    const clearTopBtn = document.getElementById("clearChatTop");
    const countEl = document.getElementById("count");
    const themeToggle = document.getElementById("themeToggle");
    const copyTranscriptBtn = document.getElementById("copyTranscript");

    const uid = () => (crypto?.randomUUID ? crypto.randomUUID() : ("id_" + Math.random().toString(16).slice(2) + Date.now()));

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function nowISO() { return new Date().toISOString(); }

    function loadStateRaw() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch {
        return [];
      }
    }

    function saveState(messages) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); } catch {}
    }

    function setTheme(theme) {
      if (!theme) {
        document.documentElement.removeAttribute("data-theme");
        localStorage.removeItem(THEME_KEY);
        return;
      }
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
    }

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "light" || saved === "dark") setTheme(saved);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme");
      if (current === "dark") setTheme("light");
      else if (current === "light") setTheme("dark");
      else setTheme("dark");
    }

    function roleLabel(role) {
      if (role === "user") return "Vous";
      if (role === "assistant") return "Assistant EME";
      return "Syst√®me";
    }

    function avatarText(role) {
      if (role === "user") return "üë§";
      if (role === "assistant") return "EME";
      return "‚ö†Ô∏è";
    }

    function formatTime(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleString(undefined, { hour: "2-digit", minute: "2-digit", year: "numeric", month: "2-digit", day: "2-digit" });
      } catch {
        return "";
      }
    }

    function renderMarkdownSafe(text) {
      if (window.marked && window.DOMPurify) {
        const html = marked.parse(text, { breaks: true, gfm: true });
        return DOMPurify.sanitize(html, {
          USE_PROFILES: { html: true },
          FORBID_TAGS: ["style", "script", "iframe", "object", "embed"],
          FORBID_ATTR: ["style", "onerror", "onclick", "onload"]
        });
      }
      return escapeHtml(text).replaceAll("\n", "<br>");
    }

    function isWelcomeBubble(msg) {
      // Remove previously saved welcome message if it exists in localStorage
      if (!msg || msg.role !== "assistant") return false;
      const t = String(msg.text || "").toLowerCase();
      return t.includes("bonjour") && t.includes("assistant officiel eme");
    }

    function loadState() {
      const raw = loadStateRaw();
      const cleaned = raw.filter(m => !isWelcomeBubble(m));
      if (cleaned.length !== raw.length) saveState(cleaned);
      return cleaned;
    }

    function syncEmptyPanel(messages) {
      // Show quick questions inside the empty chat space only when no messages
      emptyPanelEl.hidden = (messages.length > 0);
    }

    function createMsgNode(msg) {
      const wrapper = document.createElement("div");
      wrapper.className = "msg " + (msg.role === "user" ? "msg--user" : msg.role === "assistant" ? "msg--assistant" : "msg--system");

      const avatar = document.createElement("div");
      avatar.className = "msg__avatar";
      avatar.setAttribute("aria-hidden", "true");
      avatar.innerHTML = `<span>${escapeHtml(avatarText(msg.role))}</span>`;

      const bubble = document.createElement("div");
      bubble.className = "msg__bubble";
      bubble.setAttribute("data-id", msg.id);

      const meta = document.createElement("div");
      meta.className = "msg__meta";
      meta.innerHTML = `<span class="msg__role">${escapeHtml(roleLabel(msg.role))}</span><span>${escapeHtml(formatTime(msg.ts))}</span>`;

      const content = document.createElement("div");
      content.className = "msg__content";

      const isMarkdown = msg.role !== "user";
      const html = isMarkdown ? renderMarkdownSafe(msg.text) : escapeHtml(msg.text).replaceAll("\n", "<br>");
      content.innerHTML = html;

      bubble.appendChild(meta);
      bubble.appendChild(content);

      if (msg.role === "assistant") {
        const actions = document.createElement("div");
        actions.className = "msg__actions";

        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "chip";
        copyBtn.setAttribute("aria-label", "Copier la r√©ponse");
        copyBtn.textContent = "Copier";
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(msg.text);
            copyBtn.textContent = "Copi√© ‚úì";
            setTimeout(() => copyBtn.textContent = "Copier", 1200);
          } catch {
            addSystemMessage("Impossible de copier automatiquement. Vous pouvez s√©lectionner le texte et le copier.");
          }
        });

        actions.appendChild(copyBtn);
        bubble.appendChild(actions);
      }

      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);
      return wrapper;
    }

    function scrollToBottom() { chatEl.scrollTop = chatEl.scrollHeight; }

    function renderAll(messages) {
      // Keep emptyPanel in DOM and just toggle visibility
      // Clear only message nodes (we rebuild them), and keep emptyPanel by re-appending it after.
      chatEl.innerHTML = "";
      chatEl.appendChild(emptyPanelEl);

      for (const msg of messages) chatEl.appendChild(createMsgNode(msg));

      syncEmptyPanel(messages);
      scrollToBottom();
    }

    function addMessage(messages, role, text) {
      const msg = { id: uid(), ts: nowISO(), role, text: String(text ?? "") };
      messages.push(msg);
      saveState(messages);

      syncEmptyPanel(messages);
      chatEl.appendChild(createMsgNode(msg));
      scrollToBottom();
      return msg;
    }

    function addSystemMessage(text) {
      state = loadState();
      addMessage(state, "system", text);
    }

    function setSendEnabled() {
      const raw = inputEl.value ?? "";
      const trimmed = raw.trim();
      const enabled = trimmed.length > 0 && raw.length <= MAX_CHARS && !isSending;
      sendBtn.disabled = !enabled;
    }

    function updateCounter() {
      const len = (inputEl.value ?? "").length;
      countEl.textContent = `${len} / ${MAX_CHARS}`;

      const ratio = len / MAX_CHARS;
      countEl.classList.remove("warn", "danger");
      if (ratio >= 0.95) countEl.classList.add("danger");
      else if (ratio >= 0.85) countEl.classList.add("warn");
    }

    function autoresizeTextarea() {
      inputEl.style.height = "auto";
      const next = Math.min(inputEl.scrollHeight, 220);
      inputEl.style.height = next + "px";
    }

    function controllerWithTimeout(ms) {
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      return { controller, cancel: () => clearTimeout(t) };
    }

    function extractReply(json) {
      if (!json) return "";
      if (typeof json === "string") return json;
      if (typeof json.reply === "string") return json.reply;
      if (typeof json.answer === "string") return json.answer;
      if (typeof json.message === "string") return json.message;
      const c = json.choices?.[0]?.message?.content;
      if (typeof c === "string") return c;
      return "";
    }

    function demoReply(userText) {
      const t = userText.toLowerCase();
      if (t.includes("fonds bleu") || t.includes("financ")) {
        return [
          "Voici l‚Äôessentiel sur le **Fonds Bleu** (informations g√©n√©rales) :",
          "",
          "- Principe : cofinancement **sous conditions** jusqu‚Äô√† **70%** de la valeur **hors taxes**.",
          "- Priorit√© : projets structurants √† forte valeur ajout√©e (cybers√©curit√©, conformit√©, digitalisation des processus internes, int√©gration de la donn√©e/IA‚Ä¶).",
          "- Exclusion : le Fonds Bleu **n‚Äôinclut pas** la participation au financement de projets li√©s au **cloud computing**.",
          "- D√©lais : dossier complet valid√© **8 √† 10 semaines**, puis environ **1 mois** pour la commission (total ~ **3 mois**).",
          "",
          "Prochaine √©tape : consultez la page ‚ÄúFinancer son projet‚Äù sur le site EME ou contactez **fondsbleu@gouv.mc**."
        ].join("\n");
      }

      if (t.includes("autodiagnostic") || t.includes("maturit√©") || t.includes("score")) {
        return [
          "L‚Äô**autodiagnostic de maturit√© num√©rique** est le premier pas pour structurer votre transition num√©rique :",
          "",
          "- **35 questions** (environ **15 minutes**).",
          "- √âvalue 5 dimensions : **Vision du num√©rique**, **Organisation & culture**, **Pr√©sence en ligne**, **Vente & relation client**, **S√©curit√© & infrastructures**.",
          "- R√©sultat : un score **1 √† 100** + des notes par th√©matique + des recommandations.",
          "",
          "Prochaine √©tape : cr√©ez un compte sur EME, lancez l‚Äôautodiagnostic, puis utilisez les recommandations pour trouver des partenaires."
        ].join("\n");
      }

      if (t.includes("flashlearn") || t.includes("opportunit√© ia") || t.includes("2026")) {
        return [
          "Nouveaut√©s **2026** mentionn√©es sur la plateforme EME :",
          "",
          "- **Questionnaire ‚ÄúOpportunit√© IA‚Äù** : outil rapide pour identifier o√π l‚ÄôIA peut cr√©er de la valeur dans votre activit√©.",
          "- **FlashLearn IA** : parcours e-learning structur√© par th√©matiques, avec des modules courts et concrets.",
          "",
          "Prochaine √©tape : explorez la rubrique EME d√©di√©e aux ressources et √† l‚ÄôIA (Tool Box / contenus 2026)."
        ].join("\n");
      }

      if (t.includes("annuaire") || t.includes("professionnel")) {
        return [
          "L‚Äô**annuaire des professionnels du num√©rique** EME vous aide √† trouver des experts locaux pour vous accompagner :",
          "",
          "- Liste **non exhaustive** de prestataires enregistr√©s au **R√©pertoire du Commerce et de l‚ÄôIndustrie de Monaco (RCI)**.",
          "- Des prestataires mon√©gasques non list√©s peuvent aussi vous accompagner.",
          "- Attention : tous les services list√©s ne sont pas forc√©ment √©ligibles au Fonds Bleu (consultez les conditions).",
          "",
          "Prochaine √©tape : filtrez par expertise, contactez plusieurs prestataires, et comparez leur approche selon votre besoin."
        ].join("\n");
      }

      return [
        "Je peux vous aider sur : **EME**, l‚Äô**autodiagnostic**, l‚Äô**annuaire**, **FlashUP**, la **Tool Box**, et le **Fonds Bleu**.",
        "",
        "Quelle est votre question : diagnostic, financement, recherche de prestataire, ou mont√©e en comp√©tence IA (FlashLearn IA) ?"
      ].join("\n");
    }

    let state = [];
    let isSending = false;
    let pendingTypingId = null;

    function setTyping(on) {
      if (pendingTypingId) {
        const node = chatEl.querySelector(`[data-id="${pendingTypingId}"]`)?.closest(".msg");
        if (node) node.remove();
        pendingTypingId = null;
      }
      if (!on) return;

      const typing = { id: uid(), ts: nowISO(), role: "assistant", text: "" };
      pendingTypingId = typing.id;

      const wrapper = document.createElement("div");
      wrapper.className = "msg msg--assistant";

      const avatar = document.createElement("div");
      avatar.className = "msg__avatar";
      avatar.setAttribute("aria-hidden", "true");
      avatar.innerHTML = `<span>${escapeHtml(avatarText("assistant"))}</span>`;

      const bubble = document.createElement("div");
      bubble.className = "msg__bubble";
      bubble.setAttribute("data-id", typing.id);

      const meta = document.createElement("div");
      meta.className = "msg__meta";
      meta.innerHTML = `<span class="msg__role">${escapeHtml(roleLabel("assistant"))}</span><span>${escapeHtml(formatTime(typing.ts))}</span>`;

      const content = document.createElement("div");
      content.className = "msg__content";
      content.innerHTML = `
        <span class="typing" aria-label="L‚Äôassistant r√©dige une r√©ponse">
          <span>R√©flexion en cours</span>
          <span class="dots" aria-hidden="true">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </span>
        </span>
      `;

      bubble.appendChild(meta);
      bubble.appendChild(content);
      wrapper.appendChild(avatar);
      wrapper.appendChild(bubble);

      chatEl.appendChild(wrapper);
      scrollToBottom();
    }

    async function sendMessage() {
      const raw = inputEl.value ?? "";
      const trimmed = raw.trim();
      if (!trimmed) return;

      if (raw.length > MAX_CHARS) {
        addMessage(state, "system", `Votre message d√©passe la limite de ${MAX_CHARS} caract√®res. Merci de le raccourcir.`);
        return;
      }

      isSending = true;
      setSendEnabled();

      addMessage(state, "user", raw);
      setTyping(true);

      const originalInput = raw;
      const payload = { message: trimmed };

      try {
        let replyText = "";

        if (!API_URL) {
          await new Promise(r => setTimeout(r, 450));
          replyText = demoReply(trimmed);
        } else {
          const { controller, cancel } = controllerWithTimeout(TIMEOUT_MS);
          let res, json;

          try {
            res = await fetch(https://app.chatgptbuilder.io/webchat/?p=1120485&id=dVJHWjXLkq4OhmzmTo, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
              signal: controller.signal
            });
          } finally {
            cancel();
          }

          if (!res.ok) throw new Error(`Erreur serveur (${res.status})`);
          json = await res.json();
          replyText = extractReply(json);
          if (!replyText) throw new Error("R√©ponse vide ou format inattendu.");
        }

        setTyping(false);
        addMessage(state, "assistant", replyText);

        inputEl.value = "";
        updateCounter();
        autoresizeTextarea();
        inputEl.focus();

      } catch (err) {
        setTyping(false);

        const isTimeout = (err?.name === "AbortError");
        const msg = isTimeout
          ? "La requ√™te a expir√© (timeout). Merci de r√©essayer."
          : `Une erreur est survenue lors de l‚Äôenvoi (${String(err?.message || err)}).`;

        addMessage(state, "system", msg + " Votre message a √©t√© conserv√© pour r√©essayer.");

        inputEl.value = originalInput;
        updateCounter();
        autoresizeTextarea();
        inputEl.focus();
      } finally {
        isSending = false;
        setSendEnabled();
      }
    }

    function clearChat() {
      state = [];
      saveState(state);
      renderAll(state);
      inputEl.value = "";
      updateCounter();
      autoresizeTextarea();
      inputEl.focus();
      setSendEnabled();
    }

    async function copyTranscript() {
      const lines = state.map(m => {
        const who = roleLabel(m.role);
        const when = formatTime(m.ts);
        return `[${when}] ${who}: ${m.text}`;
      }).join("\n\n");

      try {
        await navigator.clipboard.writeText(lines);
        addMessage(state, "system", "Conversation copi√©e dans le presse-papiers.");
      } catch {
        addMessage(state, "system", "Impossible de copier automatiquement. Vous pouvez s√©lectionner le texte et le copier.");
      }
    }

    function wireQuickQuestions() {
      document.querySelectorAll(".chip[data-q]").forEach(btn => {
        btn.addEventListener("click", () => {
          inputEl.value = btn.getAttribute("data-q") || "";
          updateCounter();
          autoresizeTextarea();
          setSendEnabled();
          inputEl.focus();
        });
      });
    }

    function setSendEnabled() {
      const raw = inputEl.value ?? "";
      const trimmed = raw.trim();
      const enabled = trimmed.length > 0 && raw.length <= MAX_CHARS && !isSending;
      sendBtn.disabled = !enabled;
    }

    function init() {
      initTheme();

      state = loadState();
      renderAll(state);

      inputEl.addEventListener("input", () => {
        if (inputEl.value.length > MAX_CHARS) inputEl.value = inputEl.value.slice(0, MAX_CHARS);
        updateCounter();
        autoresizeTextarea();
        setSendEnabled();
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) sendMessage();
        }
      });

      sendBtn.addEventListener("click", sendMessage);
      clearBtn.addEventListener("click", clearChat);
      clearTopBtn.addEventListener("click", clearChat);
      themeToggle.addEventListener("click", toggleTheme);
      copyTranscriptBtn.addEventListener("click", copyTranscript);

      updateCounter();
      autoresizeTextarea();
      setSendEnabled();
      inputEl.focus();

      wireQuickQuestions();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>

